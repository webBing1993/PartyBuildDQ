<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="format-detection" content="telephone=no" />
    <link rel="stylesheet" href="/admin/css/plugins/toastr/toastr.min.css">
    <title>商品详情</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color:rgba(0,0,0,0);
        }
        body, div, dl, dt, dd, ul, ol, li, h1, h2, h3, h4, h5, h6, form, input, p, table, th, td, select, option {
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .clearfix:before{
            display:table;
            content:'';
        }
        .clearfix:after{
            display:table;
            content:'';
            clear:both;
        }
        body{
            padding-bottom: 55px;
        }
        .top{
            width:100%;
            display:block;
            height:50vw;
        }
        .top1{
            padding-left:12px;
        }
        .top1>p{
            font-size: 16px;
            color:#333;
            margin-top:10px;
            line-height: 22px;
        }
        .top1>span{
            font-size: 14px;
            color:#666;
            float:left;
            line-height: 34px;
        }
        .top1>a{
            padding-left: 20px;
            height:34px;
            background:url("/exchange/4.png") no-repeat left center;
            background-size:15px 15px;
            float:right;
            line-height: 34px;
            color:#ffc51e;
            font-size: 18px;
            margin-right: 12px;
        }
        .title1 {
            font-size: 15px;
            color: #333;
            height: 35px;
            line-height: 35px;
            padding-left: 12px;
            /*background: url(/work/adjust/img/2.png) no-repeat 5px center;*/
            background-size: 5px 15px;
            /*background-color: #f2f2f2;*/
            border-top:1px solid #f5f5f5;
        }

        .main{

        }
        .main>p{
            color:#666;
            font-size: 14px;
            padding-left:12px;
            padding-right:12px;
            margin-top:10px;
            margin-bottom:15px;
        }
        .titleBar{
            height:40px;
            background-color:#f5f5f5;
        }
        .titleBar>a{
            padding-left:25px;
            margin:0 auto;
            background: url("") no-repeat left center;
            background-size:15px 15px;
            font-size: 15px;
            line-height: 15px;
            margin-top:12.5px;
            display:block;
            width:90px;
        }
        .titleBar>a.red{
            color:#fc4f41;
            background-image:url(/exchange/15.png);
        }
        .other{
            height:34px;
            margin:0 auto;
            width:115px;
        }
        .other>span{
            float:left;
            width:15px;
            height:34px;
            background:url("/exchange/19.png") no-repeat center left;
            background-size:15px 15px;
        }
        .other>p{
            float:left;
            line-height: 34px;
            margin-left:10px;
            margin-right:10px;
        }
        .bot{
            position:fixed;
            bottom:0;
            width:100%;
            height:55px;
        }
        .bot>a{
            float:left;
            width:50%;
            text-align: center;
            line-height: 55px;
            background-color:#f88147;
            color:#fff;
            font-size: 16px;
        }
        .bot>a:last-child{
            background-color:#fc4f41;
        }

        .num{
            height:51px;
            padding-left:12px;
            padding-right:12px;
            border-top:10px solid #f1f1f1;
            border-bottom: 1px solid #f1f1f1;
        }
        .num>span{
            line-height: 40px;
            font-size: 15px;
            color:#333;
        }
        .num>a{
            float:right;
            height:27px;
            margin-top:6.5px;
            color:#fc4f41;
            font-size: 14px;
            line-height: 20px;
            border:1px solid #eee;
        }
        .num>a>div{
            float:left;
            padding-left:10px;
            padding-right:10px;
            border-left:1px solid #eee;
            border-right:1px solid #eee;
            line-height: 25px;
        }
        .num>a>b{
            float:left;
            width:25px;
            height:25px;
            float:left;
            background:url('/exchange/11.png') no-repeat center center;
            background-size:10px 10px;
            -webkit-tap-highlight-color:rgba(0,0,0,.5);
        }
        .num>a>b:last-child{
            background-image: url('/exchange/10.png');
        }
        .sum{
            height:40px;
            padding-left: 12px;
            padding-right: 12px;
        }
        .sum>span{
            line-height: 40px;
            font-size: 15px;
            color: #333;
            float:left;
        }
        .sum>b{
            float:right;
            line-height: 40px;
            font-size: 15px;
            font-weight: normal;
            color:#ffc51e;
            padding-left: 20px;
            height: 40px;
            background: url(/exchange/4.png) no-repeat left center;
            background-size: 14px 14px;
        }


        .bk1{
            background-color:rgba(0,0,0,.5);
            width:100%;
            position:fixed;
            top:0;
            left:0;
            z-index: 100;
            display:none;
            bottom:0;
        }
        .bk1>.content{
            width:70%;
            position:absolute;
            top: 50%;
            left:50%;
            -webkit-transform: translateY(-50%) translateX(-50%);
            background-color:#fff;
            border-radius: 8px;
            overflow: hidden;
        }
        .bk_title{
            margin-top:10px;
            text-align: center;
            font-size: 18px;
            line-height: 18px;
            margin-bottom: 40px;
            color:#0Baa0C;
            font-weight: bold;
        }
        .bk_title>span{
            display:inline-block;
            width:15px;
            height:15px;
            background:url("/work/img/sure.png") no-repeat center center;
            background-size:cover;
            margin-right:5px;
        }
        #user_img{
            width: 85px;
            height:85px;
            display:block;
            margin:0 auto;
            border-radius: 50%;
            margin-top:45px;
            margin-bottom:10px;
        }
        #user_name{
            font-size:15px;
            text-align: center;
            margin-bottom: 10px;
        }
        .btn1{
            height:55px;
            line-height: 55px;
            background-color:#eee;
        }
        .btn1>a{
            float: left;
            text-align: center;
            height:55px;
            line-height: 55px;
            width:100%;
            font-size: 16px;
        }
        .toast-top-full-width {
            top: 10px;
        }
    </style>
</head>
<body>
<img src="{$product.front_cover|get_cover='path'}"  class="top" alt="">
<div class="top1 clearfix">
    <p>{$product.title}</p>
    <span>剩余 {$product.left}</span>
    <a>{$product.price}</a>
</div>
<div class="title1">产品参数</div>
<div class="main">
    {$product.content}
</div>
{eq name="is" value="1"}
<div class="num">
    <span>数量</span>
    <a id="count">
        <b onclick="count(1)"></b>
        <div>1</div>
        <b onclick="count(2)"></b>
    </a>
</div>
<div class="bot">
    <a id="add">加入购物车</a>
    <a id="now">立即兑换</a>
</div>
<div class="sum">
    <span>总计</span>
    <b>{$product.price}</b>
</div>
{/eq}


<!--//扫描后结果-->
<div class="bk1">
    <div class="content">
        <img src="" alt="" id="user_img">
        <p id="user_name"></p>
        <div class="bk_title">
            兑 换 成 功
        </div>
        <div class="btn1">
            <a onclick="$('.bk1').hide()">完成</a>
        </div>
    </div>
</div>
<script src="/work/js/jquery-1.12.1.min.js"></script>
<script src="/admin/js/plugins/toastr/toastr.min.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script>
    $(function(){
        $('.list>li>p').width($(window).width()-92);
        $('.shopIntroduce>ul').width($(window).width()-125);
        $('.list>li').width(($(window).width()-11)*0.5-11-2);
        $('.list>li').height(($(window).width()-11)*0.5-11-2+75);
//            $('.list>li>div').css({'margin-top':$(window).width()*0.06});
        $('.list>li>div').width(($(window).width()-11)*0.5-11-2);
        $('.list>li>div').height(($(window).width()-11)*0.5-11-2);
    });

    var sum={$product.left};
    var price={$product.price};
    function count(a){
        //应该还有一个剩余数量来做判断
        var b=$('#count>div').html();
        if(a==2){
            if($('#count>div').html()<sum){
                console.log($('#count>div').html());
                $('#count>div').html(++b);
            }
        }else{
            if(b!=1){
                $('#count>div').html(--b);
            }else{
                return ;
            }
        }
        $('.sum>b').html(price*b);
    }
</script>
<script>
    var appId='{$jsSign.appid}';
    var timestamp='{$jsSign.timestamp}';
    var nonceStr='{$jsSign.noncestr}';
    var signature='{$jsSign.signature}';
    wx.config({
        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: appId, // 必填，公众号的唯一标识
        timestamp: timestamp, // 必填，生成签名的时间戳
        nonceStr: nonceStr, // 必填，生成签名的随机串
        signature: signature,// 必填，签名，见附录1
        jsApiList: ['scanQRCode','getLocation'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    });
    wx.ready(function(){
        $('#now').click(function(){
            wx.scanQRCode({
                desc: 'scanQRCode desc',
                needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
                scanType: ["qrCode","barCode"], // 可以指定扫二维码还是一维码，默认二者都有
                success: function (res) {
                    var id = {$product.id};
                    var price = {$product.price};
                    var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
                    var data = {
                        id:id,
                        num:$('#count>div').html(),
                        price:price,
                        user_id:result
                    };
                    $.ajax({
                        type: 'POST',
                        url: "{:Url('Exchange/scan')}" ,
                        data: data ,
                        success:function(data){
                            if(data.status==0){
                                alert('请扫描正确党员二维码')
                            }else if(data.status==2){
//                                var a=getNum(me.find('a').html());
//                                if((a-$('#count>div').html())==0){
//                                    me.addClass('close');
//                                }
//                                me.find('a').html('剩余 '+(getNum(me.find('a').html())-$('#count>div').html()));
                                $('#user_img').attr('src',data.header);
                                $('#user_name').html(data.name);
                                $('.bk1').show();
                                if(data.remain){
                                    $('#count>div').html('1');
                                    sum=data.remain;
                                    $('.top1>span').html('剩余 '+data.remain);
                                }else{
                                    $('.top1>span').html('剩余 '+data.remain);
                                    $('.bot').hide();
                                    $('.num').hide();
                                    $('.sum').hide();
                                }
                            }else{
                                alert('该用户积分不足');
                            }

                        }
                    });
                },
                error:function(){

                }
            });
        });

    });
    //alert 去掉连接头部
    var wAlert = window.alert;
    window.alert = function (message) {
        try {
            var iframe = document.createElement("IFRAME");
            iframe.style.display = "none";
            iframe.setAttribute("src", 'data:text/plain,');
            document.documentElement.appendChild(iframe);
            var alertFrame = window.frames[0];
            var iwindow = alertFrame.window;
            if (iwindow == undefined) {
                iwindow = alertFrame.contentWindow;
            }
            iwindow.alert(message);
            iframe.parentNode.removeChild(iframe);
        }
        catch (exc) {
            return wAlert(message);
        }
    }
    var wConfirm = window.confirm;
    window.confirm = function (message) {
        try {
            var iframe = document.createElement("IFRAME");
            iframe.style.display = "none";
            iframe.setAttribute("src", 'data:text/plain,');
            document.documentElement.appendChild(iframe);
            var alertFrame = window.frames[0];
            var iwindow = alertFrame.window;
            if (iwindow == undefined) {
                iwindow = alertFrame.contentWindow;
            }
            iwindow.confirm(message);
            iframe.parentNode.removeChild(iframe);
        }
        catch (exc) {
            return wConfirm(message);
        }
    }
</script>
<script>
    $('#add').click(function(){
        var id = {$product.id};
        $.ajax({
            type: 'POST',
            url: "{:Url('Exchange/addcar')}" ,
            data: {
                id:id,
                num:$('#count>div').html()
            } ,
            success:function(data){
                if(data.status==0){
                    alert('购物车已经存在该商品,最多还可添加'+data.num+'个');
                    $('#count>div').html(data.num);
                }else if(data.status==1){
                    toastr.success("购物车添加成功!");
                    window.location.replace('http://'+"{$link}"+'/home/exchange/merchant');
                }else{
                    alert('加入购物车失败');
                }
            }
        });
    })

    toastr.options = {
        "closeButton": true,
        "debug": false,
        "positionClass": "toast-top-full-width",
        "onclick": null,
        "showDuration": "500",
        "hideDuration": "300",
        "timeOut": "800",
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut",
        "progressBar":true
    }
</script>
</body>
</html>